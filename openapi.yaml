#
# Copyright 2025 Sascha Block
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
#

openapi: 3.1.0
info:
  title: Audit-by-Design DSL Core API
  version: 0.1.0
  description: >
    HTTP API for the Audit-by-Design DSL Core.  
    Provides canonical normalization, parsing, validation, and 
    end-to-end Requirement Atom processing.

servers:
  - url: https://api.example.com
    description: Production API endpoint (placeholder)
  - url: http://localhost:8000
    description: Local development server

paths:

  /v1/normalize:
    post:
      summary: Normalize DSL input
      description: >
        Converts arbitrary DSL text into canonical normalized form  
        (spacing, casing, terminator, commas).  
        Does **not** parse or validate grammar.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NormalizeRequest'
      responses:
        "200":
          description: Normalized DSL text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NormalizeResponse'
        "400":
          description: Invalid or missing input

  /v1/parse:
    post:
      summary: Parse DSL input into a Requirement Atom
      description: >
        Parses normalized or unnormalized DSL text using the formal  
        context-free grammar (CFG).  
        Returns an atomic Requirement representation or an error.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParseRequest'
      responses:
        "200":
          description: Successfully parsed Requirement Atom
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParseResponse'
        "422":
          description: Syntax error or malformed DSL input
        "400":
          description: Missing input

  /v1/validate:
    post:
      summary: Validate a Requirement Atom using JSON Schema
      description: >
        Performs schema validation of a Requirement Atom.  
        Ensures field consistency, binary modalities, required fields,  
        and absence of additional properties.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateRequest'
      responses:
        "200":
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        "422":
          description: Schema validation failed
        "400":
          description: Invalid or missing object

  /v1/atom:
    post:
      summary: Full end-to-end Requirement Atom pipeline
      description: >
        Performs normalization → parsing → schema validation  
        in a single unified API call.  
        Recommended for most consumers.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AtomPipelineRequest'
      responses:
        "200":
          description: Full pipeline result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AtomPipelineResponse'
        "422":
          description: Syntax or schema validation error
        "400":
          description: Missing input


components:
  schemas:

    NormalizeRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
          description: Raw DSL text to be normalized.

    NormalizeResponse:
      type: object
      properties:
        normalized:
          type: string
          description: Canonical normalized DSL text.

    ParseRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
          description: DSL text to be parsed into a Requirement Atom.

    ParseResponse:
      type: object
      properties:
        success:
          type: boolean
        requirement:
          $ref: "#/components/schemas/RequirementAtom"
        normalized:
          type: string
          description: Optional echo of normalized form.
        error:
          type: string
          nullable: true

    ValidateRequest:
      type: object
      required: [requirement]
      properties:
        requirement:
          $ref: "#/components/schemas/RequirementAtom"

    ValidateResponse:
      type: object
      properties:
        valid:
          type: boolean
        errors:
          type: array
          items:
            type: string

    AtomPipelineRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string

    AtomPipelineResponse:
      type: object
      properties:
        success:
          type: boolean
        normalized:
          type: string
        requirement:
          $ref: "#/components/schemas/RequirementAtom"
        validation:
          $ref: "#/components/schemas/ValidateResponse"
        error:
          type: string
          nullable: true

    RequirementAtom:
      type: object
      additionalProperties: false
      required: [actor, modality, action]
      properties:
        actor:
          type: string
        modality:
          type: string
          enum: ["must", "must not"]
        action:
          type: string
        condition:
          type: string
          nullable: true
        result:
          type: string
          nullable: true 
